<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
</head>
<body>
<form id="form_send_one" action="javascript:void(0);" method="post">
    <table>
        <tr>
            <td>

                <label for="data">data:</label>
            </td>
            <td>
                <input type="text" id="data" value="data"/>
            </td>
        </tr>
        <tr>
            <td>
                <label for="account">Account:</label>
            </td>
            <td>
                <input type="text" id="account" value="0001-00000000-XXXX"/>
            </td>
        </tr>
        <tr>
            <td>
                <label for="msid">msid:</label>
            </td>
            <td>
                <input type="text" id="msid" value="1"/>
            </td>
        </tr>
    </table>
    <input type="submit" value="Submit">
</form>
<button id="btn_send_2">Send two</button>

<script type="text/javascript">

    let message = {type: 'ads-1', data: '1234', account: '0001-00000000-XXXX', msid: 1};

    // port to send messsages to iframe
    let port;

    let btnSend2 = document.getElementById('btn_send_2');
    btnSend2.addEventListener('click', function () {
        console.log('index.html: click');
        console.log(port);
        if (port) {
            port.postMessage(message);
        } else {
            let callback = function (iframePort) {
                console.log('callback');
                port = iframePort;
                port.onmessage = function (event) {
                    console.log(event);
                };
                console.log(port);
                port.postMessage(message);
            };
            getIframePort(callback);
        }
    }, false);

    function getIframePort(callback) {
        // create message channel
        let channel = new MessageChannel();
        let ready = function (message) {
            // when the iframe is ready to receive messages, it will send the string 'ready'
            if (message.data && message.data === 'ready') {
                channel.port1.removeEventListener('message', ready);
                callback(channel.port1);
            } else {
                console.error('First event on iframe port was not "ready"');
            }
        };
        channel.port1.addEventListener('message', ready);
        channel.port1.start();

        // create the iframe
        const iframeOrigin = 'chrome-extension://mggldlanffdgafakkmdheppehalbddbi';
        let iframe = document.createElement('iframe');
        iframe.src = iframeOrigin + '/comm.html';
        // iframe.setAttribute('style', 'display:none');
        document.body.appendChild(iframe);

        iframe.addEventListener('load', function () {
            // pass the port of message channel to the iframe
            iframe.contentWindow.postMessage('init', iframeOrigin, [channel.port2]);
        });
    }

</script>
</body>
</html>